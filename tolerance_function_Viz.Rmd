---
title: "House Data EDA"
author: "Graeme Keleher"
date: "July 12, 2019"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load Tidyverse Suite of Packages
```{r}
library(tidyverse)  #Data wrangling and plotting
library(scales)     #Formatting axis
```

# Import Training Data
```{r message=FALSE, warning=FALSE}
train <- read_csv("train.csv")
```

# Explore Missing Values
Insight: A substantial number of features have missing data. The percentage missing varies widely. Different stratgies will most likely be required.
```{r}
na_per <- as.data.frame(round(100*colSums(is.na(train))/nrow(train),2))

colnames(na_per) <- "Percent_NA"

na_per %>%
  rownames_to_column("Feature")%>%
  filter(Percent_NA != 0)%>%
  ggplot(aes(reorder(Feature,Percent_NA),Percent_NA))+
  geom_bar(stat = "identity")+
  coord_flip()+
  labs(title = "Feautures by Percentage of Missing Data",
       y = "Percentage Missing",
       x = "")+
  geom_text(aes(label=Percent_NA),  size=3.5, nudge_y = 4)
  
```

#See if any missingness is predictive
Built a simple logistical regression model for the binary 'missingness' variable of each corresponding variable with missing values. It certainly looks like many of them are predictive. That said, some NAs have meaning outlined in the data description file. For example, an NA in the 'pool quality' feature ('PoolQC') means there is no pool. 
```{r}
#list of feautures with at least one NA
missing_data_columns <- colnames(train)[colSums(is.na(train)) >0]

train1 <- train
#make new column with this info
for(col in missing_data_columns){
  train1 <- mutate(train1, !!paste0(col,"_NA_Status") := ifelse(is.na(get(col)),1,0))
}

#Filter for Price and NA columns
Na_df <- train1 %>%
  select(SalePrice,contains("_NA_"))


p_vals <- data.frame(Var=character(),
                 P_value=numeric())

for( col in colnames(Na_df)[-1]){
  model <- glm( get(col) ~ SalePrice, data = Na_df, family = "binomial")
  s <- summary(model)$coefficients[2,4]
  p_vals <- rbind(p_vals,data.frame(Var=col, P_value=s))
}


p_vals %>%
  ggplot(aes(reorder(Var,P_value),P_value))+
  geom_bar(stat = "identity")+
  coord_flip()+
  labs(title = "Feature Missingness by P value of Predictiveness",
       subtitle = "P value from simple logistic regression predicting Sale Price",
       y = "P Value of Missingness Predicting Sale Price",
       x = "")

```

#Baseline Model
Built to 
```{r}
#transform character columns to factorogl
col_types <- sapply(train,class)

to_factor <- names(col_types[col_types == "character"])


#For character columns replace na with "NA"
#FOr numeric, repace na with 0

train_f <- train[to_factor]
train_n <- train%>%
  select(-to_factor)

train_f[is.na(train_f)] <- "Data_Missing" 
train_n[is.na(train_n)] <- 0

train_processed <- cbind(train_f, train_n)

train_processed[to_factor] <- lapply(train_processed[to_factor], as.factor)


Baseline_Model <- lm(SalePrice ~., data = train_processed)

baseline_c <- data.frame(Feature = row.names(summary(Baseline_Model)$coefficients),
                         summary(Baseline_Model)$coefficients)

baseline_c %>%
  arrange(desc(Estimate))%>%
  slice(1:10)

baseline_c %>%
  arrange(Pr...t..)%>%
  slice(1:20)

```



```{r}

#get list of catagorical features
col_types <- sapply(train,class)
to_factor <- names(col_types[col_types == "character"])
to_numeric <- names(col_types[col_types == "ch"])


#Create two data frames, one of catagorical features, one of numeric
train_n <- train %>%
  select(-to_factor)

#imput NAs to zero
train_n[is.na(train_n)] <- 0

rsquared <- data.frame(Var=character(),
                 r2=numeric())

fun_df <- train_n %>%
  select(-SalePrice, -Id)

c <- colnames(fun_df)

for( col in c){
  f=as.formula(make_formula(c,col))
  model <- lm(f , data = fun_df)
  s <- summary(model)$r.squared
  rsquared <- rbind(rsquared,data.frame(Var=col, r2=s))
}


make_formula = function(c, col){
  s = ""
  flag = 0
  
  for (v in c){
    if( v != col & flag == 1){
      s = paste0(s, " + ",v)
    }
    if( v != col & flag == 0){
      s = paste0(s,v)
      flag = 1
    }
  }
  
  s = paste0(col , " ~ ",s)
  return(s)
}

listoffactors <-  c[c != col]
reformulate(termlabels = listoffactors, response = col)
```







